# Prerequisites for the Tenstream solver are
#
#  *cmake
#  *PETSc
#  *HDF5
#  *MPI
#
# Instructions on how to install these is beyond the scope of this text.
#
# Generally you should set the following environment variables:
#
#  *HDF5_DIR
#  *PETSC_DIR
#  *PETSC_ARCH
#
#
# If you are lucky, you at the Meteorological Institute Munich and you just follow the steps below:

################ put the following in the bashrc: ########################################################
#Environment options at the Meteorological Institute Munich necessary for the tenstream solver:

TICAP=/home/opt/cosmo_tica_lib/

OMPI=1.8.1
export OMPIDIR=$TICAP/ompi$OMPI/openmpi-$OMPI/install/

if [ -n "$OMPIDIR" ]
    then # echo "setting OpenMPI environment to: $OMPIDIR"
            export LD_RUN_PATH=$OMPIDIR/lib64/:$LD_RUN_PATH
            export PATH=$OMPIDIR/bin/:$PATH
            export LD_LIBRARY_PATH=$OMPIDIR/lib64/:$LD_LIBRARY_PATH
            export MANPATH=$OMPIDIR/share/man:$MANPATH
    fi

# HDF5
export HDF5_DIR=$TICAP/ompi$OMPI/hdf5/HDF5-1.8.13-Linux/HDF_Group/HDF5/1.8.13/
export PATH=$HDF5_DIR/bin:$PATH
export LD_LIBRARY_PATH=$HDF5_DIR/lib:$LD_LIBRARY_PATH
export LD_RUN_PATH=$HDF5_DIR/lib:$LD_RUN_PATH
export HDF5_DISABLE_VERSION_CHECK=1

#PETSC
export PETSC_DIR=$TICAP/ompi$OMPI/petsc-maint
export PETSc_DIR=$PETSC_DIR
export PETSC_ARCH=fast

# Valgrind 
export PATH=$TICAP/valgrind-svn/install/bin:$PATH
export LD_LIBRARY_PATH=$TICAP/valgrind-svn/install/lib:$TICAP/valgrind-svn/install/lib64:$LD_LIBRARY_PATH
export CPATH=$TICAP/valgrind-svn/install/include:$CPATH

##########################################################################################################

# Confirm that we use the correct mpi
which mpirun

# Then check if PETSC works:
cd $PETSC_DIR && make check

# Important steps before you start:
# You should define the size of the Lookuptables and where to store them.
# For this, edit the file src/optprop_parameters.f90

# lut_basename should be a path, that is reachable for mpi_node==0.
# and if possible globally reachable so that we dont have to compute the lookuptables over and over again.

#Then build tenstream
cd -
mkdir build && cd build
cmake .. && make

# Check the tenstream runtime options with 
./bin/petsc_solver -show_options

# For a first example you could run
mpirun -np 2 ./bin/petsc_solver -ident run_test -dx 70

# If that does not throw a lot of errors at you ---

# Congratulations !!, you successfully installed the tenstream solver.
# Be proud, this is not an easy task!

# You are now ready to proceed to your libRadtran installation....
